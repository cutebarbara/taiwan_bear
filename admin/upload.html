<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Leaflet.heat CDN (å¿…é ˆåœ¨ leaflet.js ä¹‹å¾Œ) -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»‘ç†Šè³‡æ–™ä¸Šå‚³ï½œå¾Œå°</title>
  <link rel="stylesheet" href="../assets/style.css">
  <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  <style>
    a[href*="line.me"] {
      display: none !important;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <nav class="bg-white shadow-md">
    <div class="container mx-auto flex justify-between items-center py-4 px-6">
      <div class="text-2xl font-bold text-green-800">å°ç£é»‘ç†Šåµæ¸¬é è­¦ç³»çµ±ï½œå¾Œå°</div>
      <div class="space-x-6">
        <a href="../index.html" class="text-gray-700 hover:text-green-700">å›é¦–é </a>
        <a href="upload.html" class="text-green-700 font-bold">è³‡æ–™ä¸Šå‚³</a>
        <a href="announcement.html" class="text-gray-700 hover:text-green-700">å…¬å‘Šç®¡ç†</a>
        <a href="login.html" class="text-gray-700 hover:text-green-700">ç™»å…¥</a>
      </div>
    </div>
  </nav>
  <section class="container mx-auto py-8 px-4">
    <h1 class="text-2xl font-bold mb-4">é»‘ç†Šè³‡æ–™ä¸Šå‚³</h1>
    <div class="flex flex-col md:flex-row gap-6 mb-6">
      <!-- å·¦å´ï¼šä¸Šå‚³è¡¨å–® -->
      <form id="csv-upload-form" class="bg-white rounded-lg shadow p-6 flex flex-col gap-4 md:w-2/3 w-full">
        <label class="font-bold">é¸æ“‡æª”æ¡ˆï¼ˆCSV æ ¼å¼ï¼‰ï¼š
          <input id="csv-file-input" type="file" class="mt-2 border rounded p-2 w-full">
        </label>
        <button id="upload-btn" type="button" class="w-full bg-green-700 text-white py-2 rounded hover:bg-green-800 font-bold text-lg mt-2">ä¸Šå‚³</button>
      </form>
      <!-- å³å´ï¼šæ“ä½œèªªæ˜ -->
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg shadow-sm p-6 md:w-1/3 w-full flex flex-col">
        <div class="text-base font-bold flex items-center gap-2 text-yellow-800 mb-3">
          <span class="text-xl">ğŸ’¡</span>
          æ“ä½œèªªæ˜
        </div>
        <ol class="list-decimal list-inside space-y-1.5 text-sm text-gray-700 mb-4">
          <li>é¸æ“‡æª”æ¡ˆï¼šæª”æ¡ˆå…§å®¹æ‡‰åŒ…å«ã€Œç¶“ç·¯åº¦ã€ã€ã€Œæ—¥æœŸã€ã€ã€Œæ¬¡æ•¸ã€çš„ CSV æª”æ¡ˆ</li>
          <li>é»æ“Šã€Œä¸Šå‚³ã€</li>
          <li>é¸æ“‡é¡¯ç¤ºã€Œç†±é»åœ–ã€æˆ–ã€Œç›´æ–¹åœ–ã€</li>
          <li>å¯ä¸‹è¼‰åœ–è¡¨ç‚º PNG åœ–æª”</li>
        </ol>
        <div class="border-t border-yellow-200 pt-3 mt-3 text-yellow-800 text-sm font-medium">
          è«‹ä½¿ç”¨ UTF-8 ç·¨ç¢¼ï¼Œæ¬„ä½åç¨±å¯ä½¿ç”¨ä¸­æ–‡æˆ–è‹±æ–‡
        </div>
      </div>
    </div>
    <div id="csv-preview" class="my-6"></div>
    <div id="processing-msg" class="my-6 text-center text-green-700 font-bold hidden">è³‡æ–™è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
    <div id="chart-container" class="my-6 relative"></div>
    <!-- åœ–è¡¨åˆ‡æ›æŒ‰éˆ•ï¼ˆåªä¿ç•™ä¸€çµ„ï¼Œä¸¦ç¾åŒ–ï¼‰ -->
    <div class="flex justify-center gap-4 my-8" id="chart-switch-group">
      <button id="show-heatmap-btn" type="button" class="chart-switch-btn border-2 border-green-700 text-green-800 font-extrabold px-7 py-2.5 rounded-full shadow-lg transition focus:outline-none bg-gradient-to-r from-green-100 to-green-50 hover:from-green-200 hover:to-green-100 active:scale-95">ç†±é»åœ–</button>
      <button id="show-histogram-btn" type="button" class="chart-switch-btn border-2 border-blue-400 text-blue-700 font-bold px-7 py-2.5 rounded-full shadow-lg transition focus:outline-none bg-gradient-to-r from-blue-50 to-white hover:from-blue-100 hover:to-blue-50 active:scale-95">ç›´æ–¹åœ–</button>
    </div>
    <!-- ç†±é»åœ–å€å¡Šï¼ˆåŠ ä¸Šæ™‚é–“æ»‘æ¡¿èˆ‡ç¯©é¸åŠŸèƒ½ï¼‰ -->
    <div id="heatmap-section">
      <!-- æ™‚é–“æ»‘æ¡¿èˆ‡ç¯©é¸å€å¡Š -->
      <div id="heatmap-date-filter" class="flex flex-col md:flex-row items-center gap-4 bg-gray-100 rounded-lg p-4 mb-4">
        <div class="flex flex-col md:flex-row items-center gap-2 w-full">
          <label class="font-bold text-sm md:mr-2">é¸æ“‡æ—¥æœŸå€é–“ï¼š</label>
          <input id="date-range-start" type="range" min="0" max="0" value="0" class="flex-1 mx-2">
          <input id="date-range-end" type="range" min="0" max="0" value="0" class="flex-1 mx-2">
          <span id="date-range-label" class="text-gray-700 text-sm font-medium ml-2">â€”</span>
        </div>
        <button id="filter-heatmap-btn" type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow transition whitespace-nowrap">é‡æ–°ç”¢ç”Ÿç†±é»åœ–</button>
      </div>
      <div id="map" class="w-full h-[400px] md:h-[600px] max-h-[80vh] rounded-lg shadow my-6"></div>
      <div style="text-align:center; margin-top:20px;">
        <button id="download-heatmap-btn" type="button"
          class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded shadow transition">
          ä¸‹è¼‰ç†±é»åœ–
        </button>
      </div>
    </div>
    <!-- ç›´æ–¹åœ–å€å¡Šï¼ˆåªä¿ç•™ä¸€çµ„ï¼‰ -->
    <div id="histogram-section" class="my-8 bg-white rounded-lg shadow p-6 max-w-3xl mx-auto hidden">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
        <div class="text-xl font-bold text-blue-900 mb-2 md:mb-0">é»‘ç†Šå‡ºæ²’çµ±è¨ˆç›´æ–¹åœ–</div>
        <div class="flex space-x-2" id="histogram-toggle-group">
          <button type="button" data-mode="year" class="histogram-toggle-btn border-2 border-blue-400 text-blue-700 font-bold px-4 py-1 rounded transition focus:outline-none">å¹´</button>
          <button type="button" data-mode="season" class="histogram-toggle-btn border-2 border-blue-400 text-blue-700 font-bold px-4 py-1 rounded transition focus:outline-none">å­£ç¯€</button>
          <button type="button" data-mode="month" class="histogram-toggle-btn border-2 border-blue-400 text-blue-700 font-bold px-4 py-1 rounded transition focus:outline-none">æœˆ</button>
        </div>
      </div>
      <div class="bg-blue-50 rounded-lg p-4 flex flex-col items-center" style="height:420px;">
        <div style="height:400px;width:100%;display:flex;align-items:center;justify-content:center;">
          <canvas id="barChart" height="400" style="max-height:400px;max-width:100%;display:block;"></canvas>
        </div>
        <button id="download-bar-btn" type="button"
          class="mt-3 bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-6 rounded shadow transition"
          style="width:fit-content;align-self:center;">
          ä¸‹è¼‰åœ–è¡¨
        </button>
      </div>
    </div>
  </section>
  <footer class="bg-green-900 text-white py-6 mt-8">
  <script>
    // åœ–è¡¨åˆ‡æ›åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
      const heatmapSection = document.getElementById('heatmap-section');
      const histogramSection = document.getElementById('histogram-section');
      const btnHeatmap = document.getElementById('show-heatmap-btn');
      const btnHistogram = document.getElementById('show-histogram-btn');
      function setChartSwitch(active) {
        if (active === 'heatmap') {
          heatmapSection.classList.remove('hidden');
          histogramSection.classList.add('hidden');
          btnHeatmap.classList.add('border-green-700','bg-green-50','text-green-800','font-extrabold');
          btnHeatmap.classList.remove('border-blue-400','bg-white','text-blue-700');
          btnHistogram.classList.remove('border-blue-700','bg-blue-50','text-blue-900','font-extrabold');
          btnHistogram.classList.add('border-blue-400','bg-white','text-blue-700','font-bold');
        } else {
          heatmapSection.classList.add('hidden');
          histogramSection.classList.remove('hidden');
          btnHistogram.classList.add('border-blue-700','bg-blue-50','text-blue-900','font-extrabold');
          btnHistogram.classList.remove('border-blue-400','bg-white','text-blue-700');
          btnHeatmap.classList.remove('border-green-700','bg-green-50','text-green-800','font-extrabold');
          btnHeatmap.classList.add('border-blue-400','bg-white','text-blue-700','font-bold');
        }
      }
      btnHeatmap.addEventListener('click', function(){ setChartSwitch('heatmap'); });
      btnHistogram.addEventListener('click', function(){ setChartSwitch('histogram'); });
      setChartSwitch('heatmap');
    });
    // æ¬„ä½åç¨±å°æ‡‰è¡¨
    const FIELD_MAP = {
      location: ['åœ°é»', 'location', 'å€åŸŸ'],
      count: ['æ¬¡æ•¸', 'æ•¸é‡', 'count', 'organismquantity'],
      lng: ['ç¶“åº¦', 'longitude', 'lng', 'verbatimlongitude'],
      lat: ['ç·¯åº¦', 'latitude', 'lat', 'verbatimlatitude'],
      eventdate: ['eventdate', 'æ—¥æœŸ', 'date', 'äº‹ä»¶æ—¥æœŸ']
    };

    function findFieldIdx(headers, types) {
      for (let i = 0; i < headers.length; i++) {
        const h = headers[i].trim().toLowerCase();
        if (types.includes(h)) return i;
      }
      return -1;
    }

    // Leaflet ç†±é»åœ–ï¼ˆleaflet.heatï¼Œid="map"ï¼‰
    let leafletMap = null;
    let heatLayer = null;
    let isHeatmapReady = false;
    // æ—¥æœŸæ»‘æ¡¿å…¨åŸŸè®Šæ•¸
    let heatmapDateList = [];
    let heatmapRawData = [];
    let heatmapDateCol = null;
    function drawHeatmap(dataArr, latCol = 'verbatimlatitude', lngCol = 'verbatimlongitude', countCol = 'organismquantity') {
      const rawCount = dataArr.length;
      const pointMap = new Map();
      let sumLat = 0, sumLng = 0, validCount = 0;
      for (let i = 0; i < dataArr.length; i++) {
        const d = dataArr[i];
        let lat = d[latCol], lng = d[lngCol];
        if (lat === undefined || lng === undefined) continue;
        if (typeof lat === 'string') lat = lat.trim();
        if (typeof lng === 'string') lng = lng.trim();
        if (lat === '' || lng === '') continue;
        lat = parseFloat(lat);
        lng = parseFloat(lng);
        if (isNaN(lat) || isNaN(lng)) continue;
        if (!isFinite(lat) || !isFinite(lng)) continue;
        const key = lat.toFixed(6) + ',' + lng.toFixed(6);
        if (!pointMap.has(key)) {
          pointMap.set(key, { lat, lng, count: 0 });
        }
        pointMap.get(key).count += 1;
      }
      const heatData = [];
      pointMap.forEach(pt => {
        heatData.push([pt.lat, pt.lng, pt.count]);
        sumLat += pt.lat;
        sumLng += pt.lng;
        validCount++;
      });
      if (heatData.length === 0) {
        alert('ç„¡æ³•ç”¢ç”Ÿç†±é»åœ–ï¼Œå› ç‚ºç„¡æœ‰æ•ˆè³‡æ–™');
        if (leafletMap) { leafletMap.remove(); leafletMap = null; }
        isHeatmapReady = false;
        return;
      }
      let avgLat = 0, avgLng = 0, avgN = Math.min(heatData.length, 5);
      for (let i = 0; i < avgN; i++) {
        avgLat += heatData[i][0];
        avgLng += heatData[i][1];
      }
      avgLat = avgLat / avgN;
      avgLng = avgLng / avgN;
      const mapDiv = document.getElementById('map');
      if (mapDiv) {
        const newDiv = mapDiv.cloneNode(false);
        mapDiv.parentNode.replaceChild(newDiv, mapDiv);
      }
      if (leafletMap) { leafletMap.remove(); leafletMap = null; }
      leafletMap = L.map('map').setView([avgLat, avgLng], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Â© OpenStreetMap'
      }).addTo(leafletMap);
      if (heatLayer) { heatLayer.remove(); heatLayer = null; }
      let maxCount = 1;
      heatData.forEach(pt => {
        if (pt[2] > maxCount) maxCount = pt[2];
      });
      heatLayer = L.heatLayer(heatData, {
        radius: 40,
        blur: 35,
        maxZoom: 10,
        max: maxCount,
        gradient: {
          0.0: '#800080',
          0.2: '#0000ff',
          0.4: '#00ff00',
          0.6: '#ffff00',
          0.8: '#ffa500',
          1.0: '#ff0000'
        }
      }).addTo(leafletMap);
      heatData.forEach(pt => {
        const value = pt[2];
        const marker = L.marker([pt[0], pt[1]], {
          icon: L.divIcon({
            className: 'heat-label',
            html: `<div style="color:#222;font-size:13px;font-weight:bold;text-shadow:1px 1px 4px #fff;">${value}</div>`,
            iconSize: [30, 18],
            iconAnchor: [15, 9]
          })
        });
        marker.addTo(leafletMap);
      });
      const bounds = L.latLngBounds(heatData.map(pt => [pt[0], pt[1]]));
      leafletMap.fitBounds(bounds, {padding: [30, 30]});
      isHeatmapReady = true;
      document.getElementById('download-heatmap-btn').addEventListener('click', function () {
        if (!isHeatmapReady) {
          alert('è«‹å…ˆä¸Šå‚³è³‡æ–™ä¸¦ç”¢ç”Ÿç†±é»åœ–å¾Œå†ä¸‹è¼‰');
          return;
        }
        var mapDiv = document.getElementById('map');
        if (!mapDiv || !mapDiv.querySelector('canvas')) {
          alert('è«‹å…ˆä¸Šå‚³è³‡æ–™ä¸¦ç”¢ç”Ÿç†±é»åœ–å¾Œå†ä¸‹è¼‰');
          return;
        }
        html2canvas(mapDiv, {
          useCORS: true,
          backgroundColor: null
        }).then(function (canvas) {
          var link = document.createElement('a');
          link.download = 'ç†±é»åœ–.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      }, { once: true });
    }

    // ====== ç†±é»åœ–æ™‚é–“æ»‘æ¡¿èˆ‡ç¯©é¸åŠŸèƒ½ ======
    // å–å¾—æ‰€æœ‰ä¸é‡è¤‡ã€æ’åºå¾Œçš„æ—¥æœŸæ¸…å–®
    function getSortedDateList(dataArr) {
      const dateSet = new Set();
      dataArr.forEach(row => {
        const nrow = normalizeHeaders(row);
        const dateRaw = getEventDate(nrow);
        const dateObj = parseDate(dateRaw);
        if (dateObj) dateSet.add(dateObj.format('YYYY-MM-DD'));
      });
      return Array.from(dateSet).sort();
    }

    // åˆå§‹åŒ–æ»‘æ¡¿èˆ‡æ¨™ç±¤
    function setupHeatmapDateSlider(dateList) {
      const startSlider = document.getElementById('date-range-start');
      const endSlider = document.getElementById('date-range-end');
      const label = document.getElementById('date-range-label');
      if (!startSlider || !endSlider || !label || !dateList || dateList.length === 0) {
        if (label) label.textContent = 'â€”';
        return;
      }
      startSlider.min = 0;
      startSlider.max = dateList.length - 1;
      startSlider.value = 0;
      endSlider.min = 0;
      endSlider.max = dateList.length - 1;
      endSlider.value = dateList.length - 1;
      function updateLabel() {
        let s = Math.min(Number(startSlider.value), Number(endSlider.value));
        let e = Math.max(Number(startSlider.value), Number(endSlider.value));
        label.textContent = `${dateList[s]} ~ ${dateList[e]}`;
      }
      startSlider.oninput = updateLabel;
      endSlider.oninput = updateLabel;
      updateLabel();
    }

    // ä¾æ»‘æ¡¿ç¯„åœéæ¿¾è³‡æ–™
    function filterDataByDateRange(dataArr, dateList, startIdx, endIdx) {
      if (!dateList || dateList.length === 0) return [];
      const s = Math.min(startIdx, endIdx);
      const e = Math.max(startIdx, endIdx);
      const dateSet = new Set(dateList.slice(s, e + 1));
      return dataArr.filter(row => {
        const nrow = normalizeHeaders(row);
        const dateRaw = getEventDate(nrow);
        const dateObj = parseDate(dateRaw);
        if (!dateObj) return false;
        return dateSet.has(dateObj.format('YYYY-MM-DD'));
      });
    }

    // ç¶å®šæ»‘æ¡¿æŒ‰éˆ•äº‹ä»¶
    function setupHeatmapFilterButton() {
      const btn = document.getElementById('filter-heatmap-btn');
      if (!btn) return;
      btn.onclick = function() {
        if (!heatmapRawData || heatmapRawData.length === 0 || !heatmapDateList || heatmapDateList.length === 0) {
          alert('è«‹å…ˆä¸Šå‚³è³‡æ–™');
          return;
        }
        const startSlider = document.getElementById('date-range-start');
        const endSlider = document.getElementById('date-range-end');
        let s = Math.min(Number(startSlider.value), Number(endSlider.value));
        let e = Math.max(Number(startSlider.value), Number(endSlider.value));
        const filtered = filterDataByDateRange(heatmapRawData, heatmapDateList, s, e);
        if (!filtered || filtered.length === 0) {
          alert('æ‰€é¸æ—¥æœŸå€é–“å…§ç„¡è³‡æ–™');
          if (leafletMap) { leafletMap.remove(); leafletMap = null; }
          isHeatmapReady = false;
          return;
        }
        // é‡æ–°ç¹ªè£½ç†±é»åœ–
        drawHeatmap(filtered, 'verbatimlatitude', 'verbatimlongitude', 'organismquantity');
      };
    }

    // ç›´æ–¹åœ–åŠŸèƒ½
    let chartInstance = null;
    let histogramRawData = [];
    let histogramMode = 'month'; // é è¨­ã€Œæœˆã€

    // å–å¾—æ­£è¦åŒ–æ¬„ä½åç¨±
    function normalizeHeaders(row) {
      const newRow = {};
      Object.keys(row).forEach(k => {
        if (!k) return;
        const nk = k.trim().toLowerCase();
        newRow[nk] = row[k];
      });
      return newRow;
    }

    // å–å¾— eventdate æ¬„ä½ï¼ˆæ”¯æ´ BOM èˆ‡å¸¸è¦‹è®Šå½¢ï¼‰
    function getEventDate(nrow) {
      return nrow['eventdate'] || nrow['\ufeffeventdate'] || nrow['æ—¥æœŸ'] || nrow['date'] || nrow['äº‹ä»¶æ—¥æœŸ'] || '';
    }
    // å–å¾— organismquantity æ¬„ä½ï¼ˆæ”¯æ´ BOM èˆ‡å¸¸è¦‹è®Šå½¢ï¼‰
    function getOrganismQuantity(nrow) {
      return nrow['organismquantity'] || nrow['\ufefforganismquantity'] || nrow['æ•¸é‡'] || nrow['count'] || nrow['æ¬¡æ•¸'] || '';
    }

    // season helper
    function getSeason(month) {
      if ([3,4,5].includes(month)) return 'æ˜¥';
      if ([6,7,8].includes(month)) return 'å¤';
      if ([9,10,11].includes(month)) return 'ç§‹';
      return 'å†¬';
    }

    // æ—¥æœŸè§£æ
    function parseDate(str) {
      if (!str) return null;
      let d = dayjs(str, ['YYYY-MM-DD', 'YYYY/MM/DD', 'YYYY-M-D', 'YYYY/M/D'], true);
      if (!d.isValid()) d = dayjs(str);
      return d.isValid() ? d : null;
    }

    // åˆ†çµ„è³‡æ–™
    function groupHistogramData(data, mode) {
      const result = {};
      data.forEach(row => {
        const nrow = normalizeHeaders(row);
        const dateRaw = getEventDate(nrow);
        const countRaw = getOrganismQuantity(nrow);
        const dateObj = parseDate(dateRaw);
        if (!dateObj) return; // è·³éç„¡æ•ˆæ—¥æœŸ
        let count = parseInt(countRaw, 10);
        if (isNaN(count)) count = 1;
        let key = '';
        if (mode === 'year') {
          key = dateObj.format('YYYY');
        } else if (mode === 'season') {
          key = dateObj.format('YYYY') + 'å¹´' + getSeason(dateObj.month() + 1) + 'å­£';
        } else if (mode === 'month') {
          key = dateObj.format('YYYY-MM');
        }
        if (!result[key]) result[key] = 0;
        result[key] += count;
      });
      let sortedKeys = Object.keys(result);
      if (mode === 'year' || mode === 'month') {
        sortedKeys = sortedKeys.sort();
      } else if (mode === 'season') {
        sortedKeys = sortedKeys.sort((a, b) => {
          const order = { 'æ˜¥': 1, 'å¤': 2, 'ç§‹': 3, 'å†¬': 4 };
          const [ay, as] = a.match(/(\d{4})å¹´(.+)å­£/).slice(1);
          const [by, bs] = b.match(/(\d{4})å¹´(.+)å­£/).slice(1);
          if (ay !== by) return ay - by;
          return order[as] - order[bs];
        });
      }
      return { labels: sortedKeys, values: sortedKeys.map(k => result[k]) };
    }

    // ç•«ç›´æ–¹åœ–
    function renderHistogram(mode) {
      const ctx = document.getElementById('barChart').getContext('2d');
      const { labels, values } = groupHistogramData(histogramRawData, mode);
      if (chartInstance) chartInstance.destroy();
      // é˜²å‘†ï¼šè‹¥ç„¡è³‡æ–™é¡¯ç¤ºç©ºåœ–
      const chartLabels = labels.length > 0 ? labels : [''];
      const chartData = labels.length > 0 ? values : [0];
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'å‡ºç¾æ¬¡æ•¸',
            data: chartData,
            backgroundColor: 'rgba(37, 99, 235, 0.7)',
            borderColor: 'rgba(37, 99, 235, 1)',
            borderWidth: 2,
            borderRadius: 6,
            maxBarThickness: 48
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                label: function(context) {
                  return `å‡ºç¾æ¬¡æ•¸ï¼š${context.parsed.y}`;
                }
              }
            }
          },
          layout: { padding: 16 },
          scales: {
            x: {
              title: {
                display: true,
                text: mode === 'year' ? 'å¹´ä»½' : (mode === 'season' ? 'å­£ç¯€' : 'æœˆä»½'),
                color: '#1e293b',
                font: { size: 16, weight: 'bold' }
              },
              ticks: { color: '#1e293b', font: { size: 14 } },
              grid: { display: false }
            },
            y: {
              title: {
                display: true,
                text: 'ç´¯è¨ˆå‡ºç¾æ¬¡æ•¸',
                color: '#1e293b',
                font: { size: 16, weight: 'bold' }
              },
              beginAtZero: true,
              ticks: { color: '#1e293b', font: { size: 14 }, precision: 0 },
              grid: { color: '#c7d2fe', borderDash: [4, 4] }
            }
          }
        }
      });
    }

    // åˆ‡æ›åˆ†é¡æŒ‰éˆ•
    function setHistogramToggleActive(mode) {
      document.querySelectorAll('.histogram-toggle-btn').forEach(btn => {
        if (btn.dataset.mode === mode) {
          btn.classList.add('border-blue-700','bg-blue-100','text-blue-900','font-extrabold');
          btn.classList.remove('border-blue-400','bg-white','text-blue-700','font-bold');
        } else {
          btn.classList.remove('border-blue-700','bg-blue-100','text-blue-900','font-extrabold');
          btn.classList.add('border-blue-400','bg-white','text-blue-700','font-bold');
        }
      });
    }

    // åˆ‡æ›åˆ†é¡äº‹ä»¶
    document.querySelectorAll('.histogram-toggle-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const mode = btn.dataset.mode;
        if (histogramMode !== mode) {
          histogramMode = mode;
          setHistogramToggleActive(mode);
          renderHistogram(mode);
        }
      });
    });

    // é é¢è¼‰å…¥é è¨­ç©ºç›´æ–¹åœ–
    document.addEventListener('DOMContentLoaded', function() {
      setHistogramToggleActive(histogramMode);
      if (document.getElementById('barChart')) {
        renderHistogram(histogramMode);
      }
    });

    // ä¸Šå‚³æµç¨‹
    let selectedFile = null;
    document.getElementById('csv-file-input').addEventListener('change', function(e) {
      selectedFile = e.target.files[0] || null;
    });

    document.getElementById('upload-btn').addEventListener('click', function() {
      // æ¸…é™¤é è¦½è¡¨æ ¼ï¼ˆå·²ç§»é™¤è¡¨æ ¼æ¸²æŸ“ï¼‰
      document.getElementById('csv-preview').innerHTML = '';
      document.getElementById('chart-container').innerHTML = '';
      if (leafletMap) { leafletMap.remove(); leafletMap = null; }
      if (!selectedFile) {
        return;
      }
      document.getElementById('processing-msg').classList.remove('hidden');
      setTimeout(() => {
        Papa.parse(selectedFile, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            const data = results.data;
            document.getElementById('processing-msg').classList.add('hidden');
            if (!data || data.length === 0) {
              return;
            }
            // é™¤éŒ¯ï¼šé¡¯ç¤ºç¬¬ä¸€ç­†è³‡æ–™
            console.log(data[0]);

            // å·²ç§»é™¤é è¦½è¡¨æ ¼æ¸²æŸ“

            // è™•ç†ç›´æ–¹åœ–è³‡æ–™
            histogramRawData = data;
            renderHistogram(histogramMode); // é è¨­ç•«æœˆ

            // ====== ç†±é»åœ–æ»‘æ¡¿åŠŸèƒ½æ•´åˆ ======
            heatmapRawData = data;
            heatmapDateList = getSortedDateList(data);
            setupHeatmapDateSlider(heatmapDateList);
            setupHeatmapFilterButton();
            // é è¨­é¡¯ç¤ºå…¨å€é–“
            drawHeatmap(data, 'verbatimlatitude', 'verbatimlongitude', 'organismquantity');
          },
          error: function() {
            document.getElementById('processing-msg').classList.add('hidden');
          }
        });
      }, 300);
    });

    (function addHtml2Canvas() {
      var script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
      document.head.appendChild(script);
    })();
    // ç›´æ–¹åœ–ä¸‹è¼‰åŠŸèƒ½ï¼ˆç™½åº•ï¼‰
    document.addEventListener('DOMContentLoaded', function() {
      var btn = document.getElementById('download-bar-btn');
      if (btn) {
        btn.addEventListener('click', function() {
          var canvas = document.getElementById('barChart');
          if (!canvas) {
            alert('è«‹å…ˆç”¢ç”Ÿç›´æ–¹åœ–å†ä¸‹è¼‰');
            return;
          }
          // å»ºç«‹åŒå°ºå¯¸æ–° canvas
          var w = canvas.width;
          var h = canvas.height;
          var tmpCanvas = document.createElement('canvas');
          tmpCanvas.width = w;
          tmpCanvas.height = h;
          var ctx = tmpCanvas.getContext('2d');
          // å¡«ç™½åº•
          ctx.fillStyle = '#fff';
          ctx.fillRect(0, 0, w, h);
          // ç•«ä¸ŠåŸåœ–
          ctx.drawImage(canvas, 0, 0);
          // ä¸‹è¼‰
          var url = tmpCanvas.toDataURL('image/png');
          var a = document.createElement('a');
          a.href = url;
          a.download = 'ç›´æ–¹åœ–.png';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });
      }
    });
  </script>
  <style>
    .chart-switch-btn {
      min-width: 110px;
      font-size: 1.15rem;
      border-width: 2px;
      border-radius: 9999px;
      font-weight: 700;
      box-shadow: 0 2px 12px 0 rgba(16, 185, 129, 0.08);
      transition: all 0.18s cubic-bezier(.4,0,.2,1);
    }
    .chart-switch-btn:hover, .chart-switch-btn:focus {
      filter: brightness(1.08);
      box-shadow: 0 4px 18px 0 rgba(37, 99, 235, 0.13);
      font-weight: 900;
      outline: none;
      transform: translateY(-2px) scale(1.04);
    }
    .chart-switch-btn:active {
      filter: brightness(0.98);
      transform: scale(0.97);
    }
    .histogram-toggle-btn:hover, .histogram-toggle-btn:focus {
      border-color: #2563eb !important;
      background-color: #dbeafe !important;
      color: #1e40af !important;
    }
    #histogram-section {
      box-shadow: 0 2px 16px 0 rgba(37, 99, 235, 0.08);
    }
    .heat-label {
      pointer-events: none;
    }
  </style>
  <style>
    /* ç†±é»åœ–æ»‘æ¡¿å€å¡ŠéŸ¿æ‡‰å¼ */
    #heatmap-date-filter input[type=range] {
      min-width: 80px;
      max-width: 220px;
      width: 100%;
      margin: 0 4px;
    }
    #heatmap-date-filter {
      flex-wrap: wrap;
    }
    #heatmap-date-filter label {
      min-width: 80px;
    }
    #heatmap-date-filter span {
      min-width: 120px;
      text-align: center;
    }
    @media (max-width: 640px) {
      #heatmap-date-filter {
        flex-direction: column;
        align-items: stretch;
      }
      #heatmap-date-filter input[type=range] {
        max-width: 100%;
      }
      #heatmap-date-filter span {
        min-width: 80px;
      }
    }
  </style>
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center px-4" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
      <div class="mb-2 md:mb-0" style="font-size: 1rem;">
        è¯çµ¡æˆ‘å€‘ï¼š<a href="https://mail.google.com/mail/?view=cm&to=taiwanbear2025@gmail.com" target="_blank" class="underline">taiwanbear2025@gmail.com</a>
      </div>
      <div>
        <a href="https://line.me/R/ti/p/@524rcfkx" target="_blank">
          <img src="https://scdn.line-apps.com/n/line_add_friends/btn/zh-Hant.png"
               alt="åŠ å…¥å¥½å‹"
               style="height: 25px; vertical-align: middle; display: inline-block; border: none;">
        </a>
      </div>
    </div>
  </footer>
  <script>
    // å°è¦½åˆ—ç™»å…¥æŒ‰éˆ•æ ¹æ“š localStorage.role é¡¯ç¤ºèº«ä»½
    document.addEventListener('DOMContentLoaded', function() {
      var role = localStorage.getItem('role');
      var username = localStorage.getItem('username');
      var loginLink = document.querySelector('a[href="login.html"]');
      if (role && username && username !== '') {
        if (loginLink) {
          let roleText = role;
          if (role === 'admin') roleText = 'admin';
          else if (role === 'scientist') roleText = 'scientist';
          else roleText = 'other';
          loginLink.textContent = `ğŸ‘¤ ${roleText}`;
        }
      } else {
        if (loginLink) {
          loginLink.textContent = 'ç™»å…¥';
        }
      }
    });
  </script>
  <script>
    // å°è¦½åˆ—ç™»å…¥æŒ‰éˆ•æ ¹æ“š localStorage.username é¡¯ç¤ºå¸³è™Ÿ
    document.addEventListener('DOMContentLoaded', function() {
      var role = localStorage.getItem('role');
      var username = localStorage.getItem('username');
      var loginLink = document.querySelector('a[href="login.html"]');
      function isValidUserRole(username, role) {
        if (role === 'admin' && username === 'admin') return true;
        if (role === 'scientist' && (username === 'scientist1' || username === 'scientist2')) return true;
        if (role === 'other' && (username === 'other1' || username === 'other2')) return true;
        return false;
      }
      if (role && username && username !== '' && role !== '' && isValidUserRole(username, role)) {
        if (loginLink) {
          loginLink.textContent = `ğŸ‘¤ ${username}`;
        }
      } else {
        if (loginLink) {
          loginLink.textContent = 'ç™»å…¥';
        }
      }
    });
  </script>
</body>
</html>
